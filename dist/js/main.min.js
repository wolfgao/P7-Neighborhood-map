/*! frontend-nanodegree-mobile-portfolio 05-08-2017 */

function toggleBounce(marker){null!=marker.getAnimation()?marker.setAnimation(null):marker.setAnimation(google.maps.Animation.BOUNCE)}function populateInfoWindow(marker,infowindow){infowindow.marker!=marker&&(infowindow.marker=marker,model.getDataFromFourSquare(infowindow),infowindow.addListener("closeclick",function(){infowindow.setMarker=null}))}var map,locations=[{title:"Whitney Museum of American Art",location:{lat:40.7395877,lng:-74.0088629},marker:null},{title:"Park Ave Penthouse",location:{lat:40.7615772,lng:-73.9717627},marker:null},{title:"East Village Hip Studio",location:{lat:40.7281777,lng:-73.984377},marker:null},{title:"TriBeCa Artsy Bachelor Pad",location:{lat:40.7195264,lng:-74.0089934},marker:null},{title:"Museum Of Chinese In America",location:{lat:40.7195241,lng:-73.9992096},marker:null},{title:"Lincoln Center for the Performing Arts",location:{lat:40.7724641,lng:-73.9834889},marker:null},{title:"Carnegie Hall",location:{lat:40.7651283,lng:-73.9799273},marker:null},{title:"Chelsea Loft",location:{lat:40.7444883,lng:-73.9949465},marker:null},{title:"The High Line",location:{lat:40.7479925,lng:-74.0047649},marker:null},{title:"Federal Reserve Bank of New York",location:{lat:40.7083688,lng:-74.0086484},marker:null},{title:"Empire State Building",location:{lat:40.7484405,lng:-73.9856644},marker:null},{title:"Times Square",location:{lat:40.758895,lng:-73.985131},marker:null},{title:"World Trade Center Memorial Foundation",location:{lat:40.7106212,lng:-74.0155509},marker:null},{title:"New York Stock Exchange",location:{lat:40.706877,lng:-74.0112654},marker:null}],newLocations=ko.observableArray(),locationsCopy=locations.clone(),showAddList=ko.observable(),initMap=function(){map=new google.maps.Map(document.getElementById("map"),{center:{lat:40.7413549,lng:-73.9980244},zoom:13});for(var largeInfowindow=new google.maps.InfoWindow,bounds=new google.maps.LatLngBounds,i=0;i<locations.length;i++){var position=locations[i].location,title=locations[i].title;locations[i].marker=new google.maps.Marker({map:map,draggable:!0,position:position,title:title,animation:google.maps.Animation.DROP,id:i}),locations[i].marker.addListener("click",function(){toggleBounce(this),populateInfoWindow(this,largeInfowindow)}),bounds.extend(locations[i].marker.position)}map.fitBounds(bounds)},model={getDataFromFourSquare:function(infowindow){var currentDate=(new Date).Format("yyyyMMdd"),position=infowindow.marker.position,loc=position.lat()+","+position.lng();$.ajax({method:"GET",url:"https://api.foursquare.com/v2/venues/search",data:{client_id:"IY04Y4HNARJD3P0YEGEINJEC0EB3E25XEN3UF5PIX3UINKHV",client_secret:"QTKWYYYJCARMHNNNBW4OENWAMAXIGKVRKDLAGSI4YISCVDDA",v:currentDate,ll:loc}}).done(function(data){if(null!=data){var venues=data.response.venues;infoWindownView.rendor(venues,infowindow)}}).fail(function(msg){var errorMsg="<h3> Sorry, failed to get data from Foursquare right now, please check your network and try again.</h3><br> Error Message:"+msg;infowindow.setContent(errorMsg)})},getResultsFromWiki:function(location){var wikiURL="https://en.wikipedia.org/w/api.php?action=opensearch&search="+location+"&format=json";$.ajax({url:wikiURL,method:"GET",headers:{Accept:"application/json; charset=utf-8","Content-Type":"application/javascript; charset=utf-8","Access-Control-Allow-Origin":"*"},dataType:"jsonp"}).done(function(data){wikiView.rendor(data)}).fail(function(msg){$wikiElem.append('<span class="errorMsg">Error: '+msg+"</span>")})},updateMarkers:function(title){$.each(locations,function(index,val){val.title!=title&&val.marker.setMap(null)})}},omnibox={inputText:null,keyUp:function(){inputText=$("#searchboxinput").val(),inputText=inputText.replace(/(^\s*)|(\s*$)/g,"");var re=new RegExp(inputText,"gi");inputText.length>0?locationsCopy.forEach(function(val,index){re.test(val.title)?-1==newLocations.indexOf(val)&&(newLocations.push(val),val.marker.setMap(map)):-1!=newLocations.indexOf(val)&&(newLocations.remove(val),val.marker.setMap(null))}):locations.length<locationsCopy.length&&locationsCopy.forEach(function(val,index){-1==newLocations.indexOf(val)&&(newLocations.splice(index,0,val),val.marker.setMap(map))})},search:function(){this.keyUp()},clear:function(){wikiView.clear(),initMap(),$("#addressList").show()}},wikiView={rendor:function(data){var $searchbox=$("#searchbox"),search_results='<div id="search-results" class="search-results">';$searchbox.append('<button id="backBTN" onclick="omnibox.clear()">Clear</button>');var location=data[0];if(data[1].length>0){var keywords=data[1],shortDesc=data[2],keywordURLs=data[3];search_results+="<h3>"+location+" from WikiPedia</h3><li>";for(var i=0;i<data[1].length;i++)search_results+='<a href="'+keywordURLs[i]+'">'+keywords[i]+"</a>",search_results+="<p>Description: "+shortDesc[i]+"</p><br>";search_results+="</li></div>",$searchbox.append(search_results)}else{var strNotFound='<p id="notfound"><span class="notfound">Sorry, can\'t find any items with keyword "'+location+'" in wikipedia.</span></p>';$searchbox.append(strNotFound)}},clear:function(){$("#search-results")&&$("#search-results").remove(),$("#notfound")&&$("#notfound").remove(),$("#backBTN").remove()}},infoWindownView={rendor:function(venues,infowindow){for(var popWindow='<div class="infowindow" id="infowindow"><h3 align="center">'+infowindow.marker.title+"</h3>",contentDOM="",i=0;i<5;i++){var val=venues[i],name=val.name,catagories=val.categories[0].name,url=val.url;val.location.lat,val.location.lng;contentDOM+="<tr><td>"+catagories+"</td>"+("<td>"+val.location.formattedAddress+"</td>")+('<td><a href="'+url+'" class= infowindow>'+name+"</a></td>")+"</tr>"}contentDOM=popWindow+"<table><tr><th>Category:</th><th>Address:</th><th>Website:</th></tr>"+contentDOM+"</table><br>"+('<img src="'+("http://maps.googleapis.com/maps/api/streetview?location="+infowindow.marker.position.lat()+","+infowindow.marker.position.lng()+"&size=400x300&heading=60&fov=90&pitch=10")+'"></img>')+"</div>",infowindow.setContent(contentDOM),infowindow.open(map,infowindow.marker)}};$(function(){newLocations=ko.observableArray(locations);var ViewModel=function(){this.addressList=newLocations,this.showAddList=ko.observable(!0),this.loadWiki=function(item,event){0==event.button&&(model.updateMarkers(item.title),this.showAddList(!1),model.getResultsFromWiki(item.title))}};ko.applyBindings(new ViewModel)});
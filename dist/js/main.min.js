/*! frontend-nanodegree-mobile-portfolio 13-08-2017 */

function Place(data){this.name=data.name,this.lat=data.location.lat,this.lng=data.location.lng,this.category=data.categories[0].pluralName,this.address=data.location.formattedAddress,this.url=this.getUrl(data)}function toggleBounce(marker){null!=marker.getAnimation()?marker.setAnimation(null):(marker.setAnimation(google.maps.Animation.BOUNCE),window.setTimeout(function(){marker.setAnimation(null)},2e3))}function openNav(){document.getElementById("search-box").style.width="28%"}function closeNav(){document.getElementById("search-box").style.width="0"}var map,locations=[{title:"Whitney Museum of American Art",location:{lat:40.7395877,lng:-74.0088629},marker:null},{title:"Park Ave Penthouse",location:{lat:40.7615772,lng:-73.9717627},marker:null},{title:"East Village Hip Studio",location:{lat:40.7281777,lng:-73.984377},marker:null},{title:"TriBeCa Artsy Bachelor Pad",location:{lat:40.7195264,lng:-74.0089934},marker:null},{title:"Museum Of Chinese In America",location:{lat:40.7195241,lng:-73.9992096},marker:null},{title:"Lincoln Center for the Performing Arts",location:{lat:40.7724641,lng:-73.9834889},marker:null},{title:"Carnegie Hall",location:{lat:40.7651283,lng:-73.9799273},marker:null},{title:"Chelsea Loft",location:{lat:40.7444883,lng:-73.9949465},marker:null},{title:"The High Line",location:{lat:40.7479925,lng:-74.0047649},marker:null},{title:"Federal Reserve Bank of New York",location:{lat:40.7083688,lng:-74.0086484},marker:null},{title:"Empire State Building",location:{lat:40.7484405,lng:-73.9856644},marker:null},{title:"Times Square",location:{lat:40.758895,lng:-73.985131},marker:null},{title:"World Trade Center Memorial Foundation",location:{lat:40.7106212,lng:-74.0155509},marker:null},{title:"New York Stock Exchange",location:{lat:40.706877,lng:-74.0112654},marker:null}],myInfowindow;Place.prototype.getUrl=function(data){return data.url?data.url:"Website not available"};var initMap=function(){map=new google.maps.Map(document.getElementById("map"),{center:{lat:40.7413549,lng:-73.9980244},zoom:13});for(var bounds=new google.maps.LatLngBounds,largeInfowindow=new google.maps.InfoWindow,i=0;i<locations.length;i++){var position=locations[i].location,title=locations[i].title;locations[i].marker=new google.maps.Marker({map:map,draggable:!0,position:position,title:title,animation:google.maps.Animation.DROP,id:i}),locations[i].marker.addListener("click",function(){toggleBounce(this),populateInfoWindow(this,largeInfowindow)}),bounds.extend(locations[i].marker.position)}map.fitBounds(bounds)},reloadMap=function(){$.getScript("https://maps.googleapis.com/maps/api/js?libraries=places&key=AIzaSyCqYws-DUG9U254coGf2QHlzqcIj2tlRKA&v=3&callback=initMap")},mapErrorHandler=function(){$("div#map").html('error loading map...click <a href="#" onclick="reloadMap()">here</a> to reload')},populateInfoWindow=function(marker,infowindow){myInfowindow=infowindow,infowindow.marker!=marker&&(myInfowindow.marker=marker,infowindowShow(),viewModel.getDataFromFourSquare(),infowindow.addListener("closeclick",function(){infowindow.setMarker=null}))},clear=function(){$("#backBTN").remove(),$(".search-results").remove(),$(".notfound").html()&&$(".notfound").remove(),initMap(),$(".addressList").show()},infowindowShow=function(){var contentDOM='<div class="infowindow" data-bind="foreach: filterVenues" id="infowindow"><h3 align="center">'+myInfowindow.marker.title+"</h3>"+'<table><tr><th>Category:</th><th>Address:</th><th>Website:</th></tr><tr><td data-bind="text: categories"></td><td data-bind="text: address"></td><td><a data-bind="attr: {href: url, title: name }"></a></td></table><br>';contentDOM=contentDOM+('<img src="'+("http://maps.googleapis.com/maps/api/streetview?location="+myInfowindow.marker.position.lat()+","+myInfowindow.marker.position.lng()+"&size=400x300&heading=60&fov=90&pitch=10")+'"></img>')+"</div>",myInfowindow.setContent(contentDOM),myInfowindow.open(map,myInfowindow.marker)},viewModel=function(){var self=this;self.showWikiList=ko.observable(!0),self.showAddList=ko.observable(!0),self.query=ko.observable(""),self.addressList=ko.computed(function(){self.showAddList(!0);var inputText=self.query().replace(/(^\s*)|(\s*$)/g,"");if(inputText){var re=new RegExp(inputText,"gi");return locations.filter(function(val){return re.test(val.title)?(val.marker.setMap(map),!0):(val.marker.setMap(null),!1)})}return locations.forEach(function(val){val.marker&&val.marker.setMap(map)}),locations});var clearMarkers=function(title){$.each(locations,function(index,val){val.title!=title&&val.marker.setMap(null)})};self.currentWiki=ko.observable(),self.loadWiki=function(item,event){if(void 0!==event&&0==event.button){clearMarkers(item.title),self.showAddList(!1),$(".searchbox").after($(".search-results"));var wikiURL="https://en.wikipedia.org/w/api.php?action=opensearch&search="+item.title+"&format=json";$.ajax({url:wikiURL,method:"GET",headers:{Accept:"application/json; charset=utf-8","Content-Type":"application/javascript; charset=utf-8","Access-Control-Allow-Origin":"*"},dataType:"jsonp"}).done(function(data){if(data[1].length>0){var result={name:data[1][0],brief:data[2][0],url:data[3][0]};this.currentWiki=ko.observable(result),console.log(this.currentWiki())}else $("#search-results").append('<span class="notfound">Sorry, can\'t find any records from Wikipedia with this keyword "'+item.title+'"! </span>')}).fail(function(msg){$("#search-results").append('<span class="errorMsg">Error: '+msg+"</span>")})}},self.filterVenues=ko.observableArray(),self.getDataFromFourSquare=function(){self.filterVenues([]);var currentDate=(new Date).Format("yyyyMMdd"),position=myInfowindow.marker.position,loc=position.lat()+","+position.lng();$.ajax({method:"GET",url:"https://api.foursquare.com/v2/venues/search",data:{client_id:"IY04Y4HNARJD3P0YEGEINJEC0EB3E25XEN3UF5PIX3UINKHV",client_secret:"QTKWYYYJCARMHNNNBW4OENWAMAXIGKVRKDLAGSI4YISCVDDA",v:currentDate,ll:loc}}).done(function(data){if(null!=data)for(var i=0;i<3;i++){var venues=data.response.venues;self.filterVenues.push(new Place(venues[i]))}}).fail(function(msg){var errorMsg="<h3> Sorry, failed to get data from Foursquare right now, please check your network and try again.</h3><br> Error Message:"+msg;myInfowindow.setContent(errorMsg)})}};viewModel=new viewModel,ko.applyBindings(viewModel);